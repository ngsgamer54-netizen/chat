<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Nature Pro Max</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');
        
        :root { 
            --bg-color: #e5ddd5; 
            --header-bg: #f0f2f5; 
            --sidebar-bg: #fff; 
            --msg-sent: #dcf8c6; 
            --msg-received: #fff; 
            --accent: #00a884; 
            --text-color: #111;
            --sub-text: #666;
            --border-color: #ddd;
        }

        [data-theme="dark"] {
            --header-bg: #202c33;
            --sidebar-bg: #111b21;
            --msg-sent: #005c4b;
            --msg-received: #202c33;
            --text-color: #e9edef;
            --sub-text: #8696a0;
            --border-color: #222d34;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; transition: background 0.3s ease; }
        body { color: var(--text-color); overflow: hidden; }
        
        #login-page { position: fixed; inset: 0; background: url('https://w0.peakpx.com/wallpaper/818/148/HD-wallpaper-whatsapp-background-cool-dark-green-nature-pattern-thumbnail.jpg') center/cover; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        #app { display: none; width: 100vw; height: 100vh; overflow: hidden; }
        .main-wrapper { display: flex; width: 100%; height: 100%; }
        
        .side-bar { width: 30%; min-width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .user-item { padding: 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .user-item:hover { background: rgba(0,0,0,0.05); }
        
        .chat-area { width: 70%; flex: 1; position: relative; background: url('bg.jpg') center/cover; display: flex; flex-direction: column; }
        .header { height: 60px; background: var(--header-bg); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 1px solid var(--border-color); z-index: 10; }
        
        #msg-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; background: rgba(0,0,0,0.08); }
        
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); color: var(--text-color); }
        .sent { align-self: flex-end; background: var(--msg-sent); border-top-right-radius: 0; }
        .received { align-self: flex-start; background: var(--msg-received); border-top-left-radius: 0; }
        
        .msg-info { display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-size: 10px; color: var(--sub-text); margin-top: 4px; }
        .read-icon { color: #34b7f1; }

        .date-divider { align-self: center; background: rgba(0,0,0,0.2); padding: 5px 12px; border-radius: 8px; font-size: 11px; color: white; margin: 10px 0; }
        
        .input-bar { height: 62px; background: var(--header-bg); display: flex; align-items: center; padding: 0 15px; gap: 15px; }
        .input-bar input { flex: 1; padding: 10px 18px; border-radius: 20px; border: none; outline: none; font-size: 15px; background: var(--sidebar-bg); color: var(--text-color); }
        .icon-btn { cursor: pointer; font-size: 20px; color: var(--sub-text); transition: 0.2s; }
        .icon-btn:hover { color: var(--accent); }
        
        #call-screen { position: absolute; inset: 0; background: #0b141a; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .video-grid { width: 95%; height: 80%; position: relative; display: flex; gap: 10px; }
        video { width: 100%; height: 100%; border-radius: 12px; object-fit: cover; background: #000; }
        #my-video { width: 120px; height: 160px; position: absolute; bottom: 20px; right: 20px; border: 2px solid #fff; z-index: 5001; }
        
        .hidden { display: none !important; }
        .menu { position: absolute; background: var(--sidebar-bg); color: var(--text-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 2000; display: none; overflow: hidden; }
        .menu p { padding: 12px 20px; cursor: pointer; font-size: 14px; border-bottom: 1px solid var(--border-color); }
    </style>
</head>
<body onclick="hideMenus()">

    <audio id="ringtone" src="https://www.soundjay.com/phone/phone-calling-1.mp3" loop></audio>

    <div id="login-page">
        <div style="background: white; padding: 45px; border-radius: 20px; text-align: center; width: 350px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="70" style="margin-bottom: 20px;">
            <h2 style="margin-bottom: 10px; color: #444;">WhatsApp Nature</h2>
            <p style="color: #777; font-size: 14px; margin-bottom: 30px;">Professional Nature Experience</p>
            <button onclick="login()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; font-size:16px;">Continue with Google</button>
        </div>
    </div>

    <div id="msg-menu" class="menu"><p onclick="editMsgPrompt()">Edit Message</p><p onclick="deleteMsg()" style="color:red;">Delete for Everyone</p></div>
    <div id="user-menu" class="menu"><p id="pin-text" onclick="togglePin()">Pin Chat</p><p onclick="clearChat()">Clear Chat</p></div>

    <div id="app">
        <div class="main-wrapper">
            <div class="side-bar">
                <div class="header">
                    <img id="my-pic" style="width:40px; height:40px; border-radius:50%; object-fit: cover;">
                    <div style="display: flex; gap: 18px; align-items: center;">
                        <i class="fas fa-moon icon-btn" id="theme-btn" onclick="toggleDarkMode()" title="Toggle Dark Mode"></i>
                        <i class="fas fa-image icon-btn" onclick="document.getElementById('wall-input').click()" title="Wallpaper"></i>
                        <input type="file" id="wall-input" class="hidden" onchange="changeWallpaper(this)">
                        <i class="fas fa-sign-out-alt icon-btn" onclick="logout()"></i>
                    </div>
                </div>
                <div id="user-list" style="overflow-y:auto; flex:1;"></div>
            </div>

            <div class="chat-area" id="chat-bg">
                <div id="chat-window" class="hidden" style="flex:1; display:flex; flex-direction:column;">
                    <div class="header">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <img id="header-img" style="width:40px; height:40px; border-radius:50%;">
                            <div>
                                <b id="header-name"></b><br>
                                <small id="header-status" style="font-size: 11px; color: #00a884; font-weight: 500;"></small>
                            </div>
                        </div>
                        <div style="display:flex; gap:25px;">
                            <i class="fas fa-video icon-btn" onclick="startCall('video')"></i>
                            <i class="fas fa-phone-alt icon-btn" onclick="startCall('audio')"></i>
                            <i class="fas fa-search icon-btn"></i>
                        </div>
                    </div>

                    <div id="msg-container"></div>

                    <div class="input-bar">
                        <i class="far fa-smile icon-btn" id="emoji-trigger"></i>
                        <label for="file-input"><i class="fas fa-plus icon-btn"></i></label>
                        <input type="file" id="file-input" class="hidden" onchange="handleFileUpload(this)">
                        <input type="text" id="msg-input" placeholder="Type a message" oninput="handleTyping()" onkeypress="if(event.key==='Enter') sendMsg()">
                        <i class="fas fa-microphone icon-btn" id="voice-btn"></i>
                        <i class="fas fa-paper-plane" onclick="sendMsg()" style="color:var(--accent); font-size:24px; cursor:pointer;"></i>
                    </div>
                </div>

                <div id="call-screen" class="hidden">
                    <div class="video-grid">
                        <video id="remote-video" autoplay playsinline></video>
                        <video id="my-video" autoplay muted playsinline></video>
                    </div>
                    <div style="margin-top:30px; display:flex; gap:40px;">
                        <button id="accept-btn" class="hidden" style="background:#25d366; width:65px; height:65px; border-radius:50%; border:none; color:white; font-size:24px;" onclick="answerCall()"><i class="fas fa-phone"></i></button>
                        <button style="background:#ea0038; width:65px; height:65px; border-radius:50%; border:none; color:white; font-size:24px;" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCRB3ghMxx-nq1tLIXVGPj53ZdlN_W1zbI",
            authDomain: "mywhatsappclone-12e96.firebaseapp.com",
            projectId: "mywhatsappclone-12e96",
            storageBucket: "mywhatsappclone-12e96.firebasestorage.app",
            messagingSenderId: "131666791116",
            appId: "1:131666791116:web:fe41ca039c1bd9a774d069"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        const messaging = firebase.messaging();

        let pc, localStream, targetId, myCallDoc, unsubChat, selectedMsgId, selectedUserId;
        let pinnedUsers = JSON.parse(localStorage.getItem('pinned')) || [];
        const ringtone = document.getElementById('ringtone');

        function toggleDarkMode() {
            const currentTheme = document.documentElement.getAttribute("data-theme");
            const newTheme = currentTheme === "dark" ? "light" : "dark";
            document.documentElement.setAttribute("data-theme", newTheme);
            localStorage.setItem("theme", newTheme);
            document.getElementById("theme-btn").className = newTheme === "dark" ? "fas fa-sun icon-btn" : "fas fa-moon icon-btn";
        }
        if (localStorage.getItem("theme") === "dark") {
            document.documentElement.setAttribute("data-theme", "dark");
            setTimeout(() => { if(document.getElementById("theme-btn")) document.getElementById("theme-btn").className = "fas fa-sun icon-btn"; }, 100);
        }

        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function logout() { 
            db.collection("users").doc(auth.currentUser.uid).update({ status: "offline", lastSeen: Date.now() })
            .then(() => auth.signOut().then(() => location.reload()));
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('my-pic').src = user.photoURL;
                db.collection("users").doc(user.uid).set({ 
                    name: user.displayName, photo: user.photoURL, status: "online", lastSeen: Date.now() 
                }, {merge: true});
                loadUsers(); listenForCalls(user.uid); setupNotifications();
            }
        });

        function loadUsers() {
            db.collection("users").onSnapshot(snap => {
                const list = document.getElementById('user-list');
                let users = []; snap.forEach(doc => { if(doc.id !== auth.currentUser.uid) users.push({id: doc.id, ...doc.data()}); });
                users.sort((a,b) => pinnedUsers.includes(b.id) - pinnedUsers.includes(a.id));
                list.innerHTML = "";
                users.forEach(u => {
                    list.innerHTML += `
                        <div class="user-item" onclick="openChat('${u.id}', '${u.name}', '${u.photo}')" oncontextmenu="showUserMenu(event, '${u.id}')">
                            <img src="${u.photo}" style="width:45px; height:45px; border-radius:50%;">
                            <div style="flex:1">
                                <b style="font-size:15px;">${u.name}</b><br>
                                <small style="color:${u.status==='online'?'#00a884':'#666'}">${u.status==='online'?'online':'offline'}</small>
                            </div>
                            ${pinnedUsers.includes(u.id)?'<i class="fas fa-thumbtack" style="color:#00a884; font-size:12px;"></i>':''}
                        </div>`;
                });
            });
        }

        function openChat(id, name, photo) {
            targetId = id; 
            document.getElementById('chat-window').classList.remove('hidden');
            document.getElementById('header-name').innerText = name;
            document.getElementById('header-img').src = photo;
            db.collection("users").doc(id).onSnapshot(doc => {
                const data = doc.data();
                document.getElementById('header-status').innerText = data.typingTo === auth.currentUser.uid ? "typing..." : data.status;
            });
            if(unsubChat) unsubChat(); 
            loadMessages();
        }

        function loadMessages() {
            const chatId = [auth.currentUser.uid, targetId].sort().join("_");
            unsubChat = db.collection("chats").doc(chatId).collection("messages").orderBy("time", "asc").onSnapshot(snap => {
                const container = document.getElementById('msg-container');
                container.innerHTML = "";
                let lastDate = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = d.sender === auth.currentUser.uid;
                    const msgDate = d.time ? new Date(d.time.seconds * 1000).toLocaleDateString() : "Just now";
                    if(msgDate !== lastDate) {
                        container.innerHTML += `<div class="date-divider">${msgDate}</div>`;
                        lastDate = msgDate;
                    }
                    if(!isMe && !d.read) db.collection("chats").doc(chatId).collection("messages").doc(doc.id).update({read: true});
                    const time = d.time ? new Date(d.time.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
                    let content = d.text ? `<div>${d.text}</div>` : "";
                    if(d.fileUrl) content += d.fileType==='img' ? `<img src="${d.fileUrl}" style="width:100%; max-width:250px; margin-top:5px; border-radius:5px;">` : `<video src="${d.fileUrl}" controls style="width:100%; max-width:250px; margin-top:5px;"></video>`;
                    container.innerHTML += `
                        <div class="msg ${isMe ? 'sent' : 'received'}" oncontextmenu="showMsgMenu(event, '${doc.id}', ${isMe})">
                            ${content}
                            <div class="msg-info">
                                <span>${time}</span>
                                ${isMe ? `<i class="fas fa-check-double ${d.read?'read-icon':''}"></i>` : ''}
                            </div>
                        </div>`;
                });
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            });
        }

        async function triggerFCM(targetToken, title, body) {
            if (!targetToken) return;
            try {
                await fetch('https://fcm-relay-api.vercel.app/send-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: targetToken,
                        title: title,
                        body: body,
                        link: window.location.origin + "/chat/"
                    })
                });
            } catch (e) { console.error("Notification trigger failed", e); }
        }

        async function sendMsg(url = null, type = null) {
            const inp = document.getElementById('msg-input');
            if(!inp.value.trim() && !url) return;
            const messageText = inp.value;
            const chatId = [auth.currentUser.uid, targetId].sort().join("_");
            
            db.collection("chats").doc(chatId).collection("messages").add({
                text: messageText, 
                sender: auth.currentUser.uid, 
                time: firebase.firestore.FieldValue.serverTimestamp(),
                fileUrl: url, 
                fileType: type,
                read: false,
                edited: false
            });

            // Notify Receiver
            const receiverDoc = await db.collection("users").doc(targetId).get();
            const fcmToken = receiverDoc.data()?.fcmToken;
            triggerFCM(fcmToken, auth.currentUser.displayName, type ? `Sent a ${type}` : messageText);

            inp.value = "";
            db.collection("users").doc(auth.currentUser.uid).update({ typingTo: "" });
        }

        function handleTyping() {
            if(!targetId) return;
            db.collection("users").doc(auth.currentUser.uid).update({ typingTo: targetId });
            clearTimeout(window.typingTimer);
            window.typingTimer = setTimeout(() => db.collection("users").doc(auth.currentUser.uid).update({ typingTo: "" }), 2000);
        }

        async function handleFileUpload(input) {
            const f = input.files[0]; if(!f || !targetId) return;
            const ref = storage.ref(`nature_media/${Date.now()}_${f.name}`);
            await ref.put(f);
            sendMsg(await ref.getDownloadURL(), f.type.startsWith('image')?'img':'vid');
        }

        function changeWallpaper(i) {
            if(i.files[0]) {
                const r = new FileReader();
                r.onload = e => document.getElementById('chat-bg').style.backgroundImage = `url(${e.target.result})`;
                r.readAsDataURL(i.files[0]);
            }
        }

        async function setupNotifications() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/chat/firebase-messaging-sw.js');
                    const perm = await Notification.requestPermission();
                    if (perm === 'granted') {
                        const t = await messaging.getToken({ 
                            vapidKey: "BN6NESHS1TP_Vg57SoGL7kU-YDosLLnPwkn3xzemnkEaViy1P9ZyZLJRPISLAZqEbOKlsK70XGvuThoClAi19rQ",
                            serviceWorkerRegistration: registration 
                        });
                        if (t) {
                            await db.collection("users").doc(auth.currentUser.uid).update({ fcmToken: t });
                        }
                    }
                } catch (err) { console.log("Setup Error:", err); }
            }
        }

        const rtcConfig = { iceServers: [{ urls: ["stun:stun.l.google.com:19302", "stun:stun1.l.google.com:19302"] }] };
        
        async function startCall(type) {
            document.getElementById('call-screen').classList.remove('hidden');
            pc = new RTCPeerConnection(rtcConfig);
            localStream = await navigator.mediaDevices.getUserMedia({ video: type === 'video', audio: true });
            document.getElementById('my-video').srcObject = localStream;
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            
            pc.ontrack = e => document.getElementById('remote-video').srcObject = e.streams[0];
            pc.onicecandidate = e => { if(e.candidate) db.collection("calls").doc(targetId).collection("ice").add(e.candidate.toJSON()); };
            
            const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
            myCallDoc = targetId; 
            
            await db.collection("calls").doc(targetId).set({ offer, type, from: auth.currentUser.uid });

            // Send Call Notification
            const receiverDoc = await db.collection("users").doc(targetId).get();
            triggerFCM(receiverDoc.data()?.fcmToken, "Incoming Call", `${auth.currentUser.displayName} is calling you...`);

            db.collection("calls").doc(targetId).onSnapshot(doc => { if(doc.exists && doc.data().answer && pc.signalingState !== "stable") pc.setRemoteDescription(new RTCSessionDescription(doc.data().answer)); });
            db.collection("calls").doc(targetId).collection("ice").onSnapshot(snap => { snap.docChanges().forEach(c => { if(c.type === "added") pc.addIceCandidate(new RTCIceCandidate(c.doc.data())); }); });
        }

        function listenForCalls(id) {
            db.collection("calls").doc(id).onSnapshot(async doc => {
                if(!doc.exists) { if(pc) location.reload(); return; }
                if(doc.data().offer && !pc) { 
                    myCallDoc = id; targetId = doc.data().from; 
                    document.getElementById('call-screen').classList.remove('hidden'); 
                    document.getElementById('accept-btn').classList.remove('hidden'); 
                    ringtone.play().catch(()=>{}); 
                }
            });
        }

        async function answerCall() {
            ringtone.pause(); const d = (await db.collection("calls").doc(auth.currentUser.uid).get()).data();
            pc = new RTCPeerConnection(rtcConfig);
            localStream = await navigator.mediaDevices.getUserMedia({ video: d.type === 'video', audio: true });
            document.getElementById('my-video').srcObject = localStream;
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            pc.ontrack = e => document.getElementById('remote-video').srcObject = e.streams[0];
            pc.onicecandidate = e => { if(e.candidate) db.collection("calls").doc(myCallDoc).collection("ice").add(e.candidate.toJSON()); };
            await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
            const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
            await db.collection("calls").doc(myCallDoc).update({ answer: ans });
            db.collection("calls").doc(myCallDoc).collection("ice").onSnapshot(s => { s.docChanges().forEach(c => { if(c.type === "added") pc.addIceCandidate(new RTCIceCandidate(c.doc.data())); }); });
            document.getElementById('accept-btn').classList.add('hidden');
        }

        function endCall() { if(myCallDoc) db.collection("calls").doc(myCallDoc).delete(); location.reload(); }

        function showMsgMenu(e, id, me) { e.preventDefault(); if(!me) return; selectedMsgId = id; const m = document.getElementById('msg-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; }
        function showUserMenu(e, id) { e.preventDefault(); selectedUserId = id; const m = document.getElementById('user-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; }
        function hideMenus() { document.getElementById('msg-menu').style.display='none'; document.getElementById('user-menu').style.display='none'; }
        function togglePin() { if(pinnedUsers.includes(selectedUserId)) pinnedUsers = pinnedUsers.filter(i => i !== selectedUserId); else pinnedUsers.unshift(selectedUserId); localStorage.setItem('pinned', JSON.stringify(pinnedUsers)); loadUsers(); }
        function deleteMsg() { const cid = [auth.currentUser.uid, targetId].sort().join("_"); db.collection("chats").doc(cid).collection("messages").doc(selectedMsgId).delete(); }
        function editMsgPrompt() { const t = prompt("Edit message:"); if(t) { const cid = [auth.currentUser.uid, targetId].sort().join("_"); db.collection("chats").doc(cid).collection("messages").doc(selectedMsgId).update({ text: t, edited: true }); } }

        window.onload = () => {
            const picker = new EmojiButton({ position: 'top-start', rootElement: document.body, zIndex: 9999 });
            const btn = document.querySelector('#emoji-trigger');
            if(btn) {
                btn.onclick = () => picker.togglePicker(btn);
                picker.on('emoji', s => { document.querySelector('#msg-input').value += s; });
            }
        };
    </script>
</body>
</html>
